groups:
  - name: scratch-card-license-alerts
    interval: 30s
    rules:
      # High Failure Rate Alerts
      - alert: ScratchCardHighFailureRate
        expr: |
          (
            sum(rate(scratch_card_failures_by_type_total[5m])) /
            sum(rate(scratch_card_activations_total[5m]))
          ) * 100 > 10
        for: 5m
        labels:
          severity: warning
          service: isx-license
          component: scratch-card
        annotations:
          summary: "High scratch card activation failure rate detected"
          description: |
            Scratch card activation failure rate is {{ $value | humanizePercentage }} over the last 5 minutes.
            This exceeds the 10% threshold and may indicate system issues.
            Current rate: {{ $value | humanizePercentage }}

      - alert: ScratchCardCriticalFailureRate
        expr: |
          (
            sum(rate(scratch_card_failures_by_type_total[5m])) /
            sum(rate(scratch_card_activations_total[5m]))
          ) * 100 > 25
        for: 2m
        labels:
          severity: critical
          service: isx-license
          component: scratch-card
        annotations:
          summary: "Critical scratch card activation failure rate"
          description: |
            Scratch card activation failure rate is {{ $value | humanizePercentage }} over the last 5 minutes.
            This exceeds the critical 25% threshold. Immediate investigation required.
            Current rate: {{ $value | humanizePercentage }}

      # Apps Script Performance Alerts
      - alert: AppsScriptSlowResponse
        expr: |
          histogram_quantile(0.95, sum(rate(apps_script_response_time_seconds_bucket[5m])) by (le)) > 5
        for: 5m
        labels:
          severity: warning
          service: isx-license
          component: apps-script
        annotations:
          summary: "Apps Script API response time is slow"
          description: |
            Apps Script API 95th percentile response time is {{ $value | humanizeDuration }}.
            This exceeds the 5 second threshold and may impact user experience.
            Current P95: {{ $value | humanizeDuration }}

      - alert: AppsScriptErrors
        expr: |
          rate(apps_script_errors_total[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
          service: isx-license
          component: apps-script
        annotations:
          summary: "High Apps Script error rate detected"
          description: |
            Apps Script error rate is {{ $value | humanize }} errors/second over the last 5 minutes.
            This may indicate connectivity or quota issues with Google Apps Script.
            Current error rate: {{ $value | humanize }}/sec

      - alert: AppsScriptConnectivityLoss
        expr: |
          apps_script_connectivity < 1
        for: 1m
        labels:
          severity: critical
          service: isx-license
          component: apps-script
        annotations:
          summary: "Apps Script connectivity lost"
          description: |
            Apps Script connectivity is down. License activations may fail.
            Immediate investigation and restoration required.
            Status: {{ if eq $value 0.0 }}Disconnected{{ else }}Partially Connected{{ end }}

      # Rate Limiting Alerts
      - alert: AppsScriptRateLimitSpike
        expr: |
          rate(apps_script_rate_limits_total[5m]) > 0.05
        for: 2m
        labels:
          severity: warning
          service: isx-license
          component: apps-script
        annotations:
          summary: "Apps Script rate limiting detected"
          description: |
            Apps Script rate limiting events: {{ $value | humanize }}/second over the last 5 minutes.
            Consider reducing request frequency or implementing backoff strategies.
            Current rate limit hits: {{ $value | humanize }}/sec

      - alert: LicenseSystemRateLimitSpike
        expr: |
          rate(license_rate_limit_hits_total[5m]) > 0.1
        for: 1m
        labels:
          severity: warning
          service: isx-license
          component: rate-limiter
        annotations:
          summary: "License system rate limiting active"
          description: |
            License system rate limiting: {{ $value | humanize }}/second over the last 5 minutes.
            High traffic detected, some requests may be throttled.
            Current rate limit hits: {{ $value | humanize }}/sec

      # Device Fingerprint Alerts
      - alert: FingerprintMismatchSpike
        expr: |
          rate(fingerprint_mismatches_total[5m]) > 0.05
        for: 3m
        labels:
          severity: warning
          service: isx-license
          component: fingerprint
        annotations:
          summary: "High device fingerprint mismatch rate"
          description: |
            Device fingerprint mismatches: {{ $value | humanize }}/second over the last 5 minutes.
            This may indicate device spoofing attempts or legitimate device changes.
            Current mismatch rate: {{ $value | humanize }}/sec

      - alert: FingerprintGenerationSlow
        expr: |
          histogram_quantile(0.95, rate(fingerprint_generation_duration_seconds_bucket[5m])) > 2
        for: 5m
        labels:
          severity: warning
          service: isx-license
          component: fingerprint
        annotations:
          summary: "Device fingerprint generation is slow"
          description: |
            Device fingerprint generation P95 time is {{ $value | humanizeDuration }}.
            This exceeds the 2 second threshold and may impact activation speed.
            Current P95: {{ $value | humanizeDuration }}

      # Batch Processing Alerts
      - alert: BatchProcessingSlow
        expr: |
          histogram_quantile(0.95, rate(batch_processing_duration_seconds_bucket[5m])) > 30
        for: 5m
        labels:
          severity: warning
          service: isx-license
          component: batch-processor
        annotations:
          summary: "Batch processing is slow"
          description: |
            Batch processing P95 time is {{ $value | humanizeDuration }}.
            This exceeds the 30 second threshold for batch operations.
            Current P95: {{ $value | humanizeDuration }}

      - alert: HighPendingCardCount
        expr: |
          active_pending_cards > 1000
        for: 5m
        labels:
          severity: warning
          service: isx-license
          component: batch-processor
        annotations:
          summary: "High number of pending scratch cards"
          description: |
            Active pending scratch cards: {{ $value | humanize }}
            This exceeds the 1000 card threshold and may indicate processing bottlenecks.
            Current pending cards: {{ $value | humanize }}

      - alert: CriticalPendingCardCount
        expr: |
          active_pending_cards > 5000
        for: 2m
        labels:
          severity: critical
          service: isx-license
          component: batch-processor
        annotations:
          summary: "Critical number of pending scratch cards"
          description: |
            Active pending scratch cards: {{ $value | humanize }}
            This exceeds the critical 5000 card threshold. Immediate scaling required.
            Current pending cards: {{ $value | humanize }}

      # Security Alerts
      - alert: SecurityEventSpike
        expr: |
          rate(license_security_events_total[5m]) > 0.1
        for: 1m
        labels:
          severity: warning
          service: isx-license
          component: security
        annotations:
          summary: "Unusual security event activity detected"
          description: |
            Security events: {{ $value | humanize }}/second over the last 5 minutes.
            This may indicate attempted attacks or system misuse.
            Current security event rate: {{ $value | humanize }}/sec

      - alert: InvalidKeyAttemptSpike
        expr: |
          rate(license_invalid_key_attempts_total[5m]) > 0.2
        for: 2m
        labels:
          severity: warning
          service: isx-license
          component: security
        annotations:
          summary: "High rate of invalid license key attempts"
          description: |
            Invalid key attempts: {{ $value | humanize }}/second over the last 5 minutes.
            This may indicate brute force attacks or invalid key generation.
            Current invalid attempt rate: {{ $value | humanize }}/sec

      # System Health Alerts
      - alert: LicenseServiceDown
        expr: |
          up{job="isx-license-service"} == 0
        for: 1m
        labels:
          severity: critical
          service: isx-license
          component: service
        annotations:
          summary: "ISX License Service is down"
          description: |
            The ISX License Service is not responding to health checks.
            All license operations are affected. Immediate intervention required.
            Service status: DOWN

      - alert: GoogleSheetsConnectivityLoss
        expr: |
          license_sheets_connectivity < 1
        for: 2m
        labels:
          severity: warning
          service: isx-license
          component: google-sheets
        annotations:
          summary: "Google Sheets connectivity issues"
          description: |
            Google Sheets connectivity is degraded or lost.
            License data synchronization may be affected.
            Connectivity status: {{ if eq $value 0.0 }}Disconnected{{ else }}Partially Connected{{ end }}

      # Performance Degradation Alerts
      - alert: LicenseValidationSlow
        expr: |
          histogram_quantile(0.95, rate(license_validation_duration_seconds_bucket[5m])) > 3
        for: 5m
        labels:
          severity: warning
          service: isx-license
          component: validation
        annotations:
          summary: "License validation is slow"
          description: |
            License validation P95 time is {{ $value | humanizeDuration }}.
            This exceeds the 3 second threshold and may impact user experience.
            Current P95: {{ $value | humanizeDuration }}

      - alert: CacheEfficiencyLow
        expr: |
          (
            rate(license_validation_cache_hits_total[5m]) /
            (rate(license_validation_cache_hits_total[5m]) + rate(license_validation_cache_misses_total[5m]))
          ) * 100 < 70
        for: 10m
        labels:
          severity: warning
          service: isx-license
          component: cache
        annotations:
          summary: "License cache efficiency is low"
          description: |
            Cache hit rate is {{ $value | humanizePercentage }} over the last 10 minutes.
            This is below the 70% efficiency threshold and may indicate cache issues.
            Current hit rate: {{ $value | humanizePercentage }}